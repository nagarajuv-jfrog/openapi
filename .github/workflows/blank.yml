name: Sync OpenAPI definition to ReadMe

on:
  push:
    branches:
      - main

jobs:
  sync:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        api-config:
          # Artifactory Security
          - { file: './artifactory-security.json', slug: 'artifactory-security' }
          - { file: './artifactory-security-deprecated-security-apis.json', slug: 'artifactory-security-deprecated' }
          
          # Artifacts Storage
          - { file: './artifacts---storage.json', slug: 'artifacts-storage' }
          - { file: './artifacts---storage-deploy-artifact-apis.json', slug: 'artifacts-storage-deploy' }
          - { file: './artifacts---storage-item-properties-apis.json', slug: 'artifacts-storage-item-properties' }
          - { file: './artifacts---storage-repository-replication-apis.json', slug: 'artifacts-storage-replication' }
          - { file: './artifacts---storage-trash-can-garbage-collection-apis.json', slug: 'artifacts-storage-trash-can' }
          
          # Builds & Release Management
          - { file: './builds.json', slug: 'builds' }
          - { file: './release-bundles-v1.json', slug: 'release-bundles-v1' }
          - { file: './release-lifecycle-management-release-bundle-v2-apis.json', slug: 'release-lifecycle-management-v2' }
          - { file: './release-lifecycle-management-release-bundle-v2-promotion-apis.json', slug: 'release-lifecycle-management-v2-promotion' }
          - { file: './retention--release-bundle-v1-.json', slug: 'retention-release-bundle-v1' }
          
          # Federated Repositories
          - { file: './federated-repositories.json', slug: 'federated-repositories' }
          - { file: './federated-repositories-artifactory-federation-service-monitoring.json', slug: 'federated-repositories-monitoring' }
          - { file: './federated-repositories-legacy-federation-monitoring.json', slug: 'federated-repositories-legacy-monitoring' }
          
          # Repositories & Import/Export
          - { file: './repositories.json', slug: 'repositories' }
          - { file: './repositories-get-puppet-apis.json', slug: 'repositories-puppet' }
          - { file: './import---export.json', slug: 'import-export' }
          
          # Miscellaneous Services
          - { file: './cold-storage.json', slug: 'cold-storage' }
          - { file: './evidence.json', slug: 'evidence' }
          - { file: './loggers.json', slug: 'loggers' }
          - { file: './plugins.json', slug: 'plugins' }
          - { file: './searches.json', slug: 'searches' }
          - { file: './smart-archiving.json', slug: 'smart-archiving' }
          - { file: './swagger.json', slug: 'swagger' }

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Sync ${{ matrix.api-config.slug }}
        env:
          README_API_KEY: ${{ secrets.README_API_KEY }}
        run: |
          # Debug: Check if API Key is set (length check only)
          if [ -z "$README_API_KEY" ]; then
            echo "Error: README_API_KEY is not set!"
            exit 1
          else
            echo "README_API_KEY is set (length: ${#README_API_KEY})"
          fi

          # 1. Fetch all existing APIs from ReadMe
          # Capture HTTP status code
          HTTP_CODE=$(curl -s -o apis.json -w "%{http_code}" -u "$README_API_KEY:" https://dash.readme.com/api/v1/api-specification)
          
          echo "API Request Status Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "Error: Failed to fetch APIs from ReadMe."
            echo "Response Body:"
            cat apis.json
            exit 1
          fi
          
          # Check if response is a valid JSON array
          if ! jq -e 'if type=="array" then true else false end' apis.json > /dev/null; then
             echo "Error: ReadMe API returned unexpected format:"
             cat apis.json
             exit 1
          fi

          # 2. Extract Title from local JSON
          TITLE=$(jq -r .info.title "${{ matrix.api-config.file }}")
          SLUG="${{ matrix.api-config.slug }}"
          
          echo "Processing: $TITLE (Slug: $SLUG)"
          
          # 3. Find matching ID by Title OR Slug
          # This handles the mismatch that causes "already exists" errors
          ID=$(jq -r --arg t "$TITLE" --arg s "$SLUG" '.[] | select(.title == $t or .slug == $s) | .id' apis.json | head -n 1)
          
          # 4. Run rdme CLI with the correct ID (if found) or Slug (if new)
          if [ -n "$ID" ] && [ "$ID" != "null" ]; then
            echo "✓ Found existing API definition (ID: $ID). Updating..."
            npx --yes rdme@v10 openapi upload "${{ matrix.api-config.file }}" --key="$README_API_KEY" --id="$ID" --confirm-overwrite
          else
            echo "✚ No existing API found. Creating new..."
            npx --yes rdme@v10 openapi upload "${{ matrix.api-config.file }}" --key="$README_API_KEY" --slug="$SLUG" --confirm-overwrite
          fi
